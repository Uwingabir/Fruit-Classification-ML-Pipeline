<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Classification Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .status-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-operational {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #e9ecef;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .prediction-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .prediction-result h3 {
            margin-bottom: 10px;
        }

        .confidence-bar {
            height: 30px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: width 0.5s;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .class-selector {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
        }

        .progress-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s;
        }

        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }

        #uploadedFiles {
            margin-top: 10px;
            font-size: 0.9em;
            color: #495057;
        }

        .chart-container {
            min-height: 400px;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-label:hover {
            background: #5568d3;
        }
        .info-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .info-banner h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }

        .info-banner ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-banner li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçé Fruit Classification Dashboard</h1>

        <!-- Important Info Banner -->
        <div class="info-banner">
            <h3>‚ÑπÔ∏è Important: This Model Only Works With These Fruits!</h3>
            <p><strong>‚úÖ Supported Images:</strong></p>
            <ul>
                <li>üçé Apples (Fresh or Rotten)</li>
                <li>üçå Bananas (Fresh or Rotten)</li>
                <li>üçä Oranges (Fresh or Rotten)</li>
            </ul>
            <p><strong>‚ùå Other images (people, objects, other fruits) will give WRONG predictions!</strong></p>
            <p style="margin-top: 10px; font-size: 0.9em;">
                <em>The model was trained only on these 6 categories and cannot recognize anything else.</em>
            </p>
        </div>

        <div class="dashboard-grid">
            <!-- Model Status Card -->
            <div class="card">
                <h2>üìä Model Status</h2>
                <div class="status-card">
                    <span class="status-label">Status:</span>
                    <span class="status-badge" id="modelStatus">Checking...</span>
                </div>
                <div class="status-card">
                    <span class="status-label">Uptime:</span>
                    <span class="status-value" id="uptime">0s</span>
                </div>
                <div class="status-card">
                    <span class="status-label">Predictions:</span>
                    <span class="status-value" id="predictionCount">0</span>
                </div>
                <div class="status-card">
                    <span class="status-label">Model Size:</span>
                    <span class="status-value" id="modelSize">-</span>
                </div>
            </div>

            <!-- Single Prediction Card -->
            <div class="card">
                <h2>üîÆ Single Prediction</h2>
                <div class="upload-area" id="uploadArea">
                    <p>üìÅ Drag & Drop or Click to Upload Image</p>
                    <input type="file" id="imageInput" accept="image/*">
                    <label for="imageInput" class="file-label">Choose File</label>
                </div>
                <div id="uploadedFiles"></div>
                <img id="previewImage" class="preview-image" style="display:none;">
                <button class="btn btn-primary" id="predictBtn" style="display:none;" onclick="predictImage()">
                    üîç Predict
                </button>
                <div id="predictionResult"></div>
            </div>
        </div>

        <!-- Visualizations -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>üìà Data Visualizations</h2>
            <div class="dashboard-grid">
                <div class="chart-container" id="classDistChart"></div>
                <div class="chart-container" id="uptimeChart"></div>
            </div>
        </div>

        <!-- Bulk Upload & Retraining -->
        <div class="dashboard-grid">
            <div class="card">
                <h2>üì¶ Bulk Upload for Retraining</h2>
                <select class="class-selector" id="classSelector">
                    <option value="">Select Fruit Class</option>
                    <option value="freshapples">Fresh Apples</option>
                    <option value="freshbanana">Fresh Banana</option>
                    <option value="freshoranges">Fresh Oranges</option>
                    <option value="rottenapples">Rotten Apples</option>
                    <option value="rottenbanana">Rotten Banana</option>
                    <option value="rottenoranges">Rotten Oranges</option>
                </select>
                <div class="upload-area" id="bulkUploadArea">
                    <p>üìÅ Upload Multiple Images for Training</p>
                    <input type="file" id="bulkImageInput" accept="image/*" multiple>
                    <label for="bulkImageInput" class="file-label">Choose Files</label>
                </div>
                <div id="bulkUploadStatus"></div>
                <button class="btn btn-success" id="uploadBtn" onclick="uploadBulkData()">
                    ‚¨ÜÔ∏è Upload Training Data
                </button>
            </div>

            <div class="card">
                <h2>üîÑ Model Retraining</h2>
                <div class="log-area" id="retrainLog">
                    <div class="log-entry">Ready to retrain model...</div>
                </div>
                <div class="progress-bar" style="margin: 20px 0;">
                    <div class="progress-fill" id="retrainProgress" style="width: 0%;">0%</div>
                </div>
                <button class="btn btn-danger" id="retrainBtn" onclick="triggerRetraining()">
                    üöÄ Start Retraining
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let selectedImage = null;
        let bulkImages = null;
        let uptimeData = { x: [], y: [] };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateModelStatus();
            setupDragDrop();
            setupFileInputs();
            
            // Update status every 5 seconds
            setInterval(updateModelStatus, 5000);
            
            // Check retraining status every 2 seconds
            setInterval(checkRetrainingStatus, 2000);
        });

        // Update model status
        async function updateModelStatus() {
            try {
                const response = await axios.get(`${API_BASE}/model-info`);
                const data = response.data;
                
                document.getElementById('modelStatus').textContent = 'Operational';
                document.getElementById('modelStatus').className = 'status-badge status-operational';
                document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds);
                document.getElementById('predictionCount').textContent = data.prediction_count;
                document.getElementById('modelSize').textContent = 
                    data.model_info.model_size_mb + ' MB';
                
                // Update uptime chart
                updateUptimeChart(data.uptime_seconds);
                
            } catch (error) {
                document.getElementById('modelStatus').textContent = 'Error';
                document.getElementById('modelStatus').className = 'status-badge status-error';
                console.error('Error fetching model status:', error);
            }
        }

        // Format uptime
        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        // Setup drag and drop
        function setupDragDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageSelection(files[0]);
                }
            });
        }

        // Setup file inputs
        function setupFileInputs() {
            document.getElementById('imageInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageSelection(e.target.files[0]);
                }
            });
            
            document.getElementById('bulkImageInput').addEventListener('change', (e) => {
                bulkImages = e.target.files;
                document.getElementById('bulkUploadStatus').innerHTML = 
                    `<p>Selected ${bulkImages.length} files</p>`;
            });
        }

        // Handle image selection
        function handleImageSelection(file) {
            selectedImage = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('previewImage');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // Show predict button
            document.getElementById('predictBtn').style.display = 'inline-block';
            document.getElementById('uploadedFiles').innerHTML = 
                `<p>üìÑ ${file.name}</p>`;
        }

        // Predict image
        async function predictImage() {
            if (!selectedImage) return;
            
            const formData = new FormData();
            formData.append('file', selectedImage);
            
            const predictBtn = document.getElementById('predictBtn');
            predictBtn.disabled = true;
            predictBtn.textContent = '‚è≥ Predicting...';
            
            try {
                const response = await axios.post(`${API_BASE}/predict`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
                const result = response.data;
                displayPredictionResult(result);
                updateClassDistribution(result);
                
            } catch (error) {
                alert('Prediction failed: ' + error.message);
            } finally {
                predictBtn.disabled = false;
                predictBtn.textContent = 'üîç Predict';
            }
        }

        // Display prediction result
        function displayPredictionResult(result) {
            const confidencePercent = (result.confidence * 100).toFixed(2);
            const confidence = result.confidence;
            
            // Determine warning level and colors
            let warningClass = '';
            let warningBanner = '';
            let barColor = '#4CAF50'; // Green
            
            if (confidence < 0.5) {
                warningClass = 'warning-high';
                barColor = '#dc3545'; // Red
                warningBanner = `
                    <div style="background: #dc3545; color: white; padding: 15px; border-radius: 5px; margin-bottom: 15px; font-weight: bold;">
                        ‚ö†Ô∏è WARNING: Very Low Confidence! This is likely NOT a fruit image!
                        <br><small>This model only works with apples, bananas, and oranges.</small>
                    </div>
                `;
            } else if (confidence < 0.7) {
                warningClass = 'warning-medium';
                barColor = '#ffc107'; // Yellow/Orange
                warningBanner = `
                    <div style="background: #ffc107; color: #000; padding: 15px; border-radius: 5px; margin-bottom: 15px; font-weight: bold;">
                        ‚ö†Ô∏è CAUTION: Moderate Confidence - Result may be unreliable
                        <br><small>Make sure image contains apples, bananas, or oranges.</small>
                    </div>
                `;
            }
            
            const resultHTML = `
                ${warningBanner}
                <div class="prediction-result ${warningClass}">
                    <h3>Prediction Result</h3>
                    <p><strong>Class:</strong> ${result.predicted_class}</p>
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${confidencePercent}%; background: ${barColor};">
                            ${confidencePercent}%
                        </div>
                    </div>
                    <p style="margin-top: 10px;">${result.interpretation}</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">
                        <em>Response time: ${result.prediction_time_ms}ms</em>
                    </p>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 0.85em;">
                        <strong>‚ÑπÔ∏è Model Info:</strong> This model is trained ONLY on:
                        <br>‚Ä¢ Fresh & Rotten Apples üçé
                        <br>‚Ä¢ Fresh & Rotten Bananas üçå  
                        <br>‚Ä¢ Fresh & Rotten Oranges üçä
                        <br><em>Other images will produce unreliable results!</em>
                    </div>
                </div>
            `;
            
            document.getElementById('predictionResult').innerHTML = resultHTML;
        }

        // Upload bulk data
        async function uploadBulkData() {
            const className = document.getElementById('classSelector').value;
            
            if (!className) {
                alert('Please select a class first!');
                return;
            }
            
            if (!bulkImages || bulkImages.length === 0) {
                alert('Please select images to upload!');
                return;
            }
            
            const formData = new FormData();
            formData.append('class_name', className);
            
            for (let i = 0; i < bulkImages.length; i++) {
                formData.append('files', bulkImages[i]);
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Uploading...';
            
            try {
                const response = await axios.post(
                    `${API_BASE}/upload-training-data`,
                    formData,
                    { headers: { 'Content-Type': 'multipart/form-data' } }
                );
                
                const result = response.data;
                document.getElementById('bulkUploadStatus').innerHTML = `
                    <p style="color: green; margin-top: 10px;">
                        ‚úì Uploaded ${result.uploaded_count} files successfully!
                    </p>
                `;
                
                // Clear selection
                document.getElementById('bulkImageInput').value = '';
                bulkImages = null;
                
            } catch (error) {
                alert('Upload failed: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = '‚¨ÜÔ∏è Upload Training Data';
            }
        }

        // Trigger retraining
        async function triggerRetraining() {
            if (!confirm('Start model retraining? This may take several minutes.')) {
                return;
            }
            
            const retrainBtn = document.getElementById('retrainBtn');
            retrainBtn.disabled = true;
            
            try {
                await axios.post(`${API_BASE}/retrain`);
                addLogEntry('Retraining started...');
            } catch (error) {
                alert('Failed to start retraining: ' + error.message);
                retrainBtn.disabled = false;
            }
        }

        // Check retraining status
        async function checkRetrainingStatus() {
            try {
                const response = await axios.get(`${API_BASE}/retraining-status`);
                const status = response.data;
                
                const progressBar = document.getElementById('retrainProgress');
                progressBar.style.width = status.progress + '%';
                progressBar.textContent = status.progress + '%';
                
                if (status.message) {
                    addLogEntry(status.message);
                }
                
                const retrainBtn = document.getElementById('retrainBtn');
                retrainBtn.disabled = status.is_retraining;
                
                if (!status.is_retraining && status.progress === 100) {
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressBar.textContent = '0%';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error checking retraining status:', error);
            }
        }

        // Add log entry
        function addLogEntry(message) {
            const logArea = document.getElementById('retrainLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Update class distribution chart
        function updateClassDistribution(result) {
            const classes = Object.keys(result.probabilities);
            const probs = Object.values(result.probabilities);
            
            const data = [{
                x: classes,
                y: probs,
                type: 'bar',
                marker: {
                    color: probs.map((p, i) => 
                        classes[i] === result.predicted_class ? '#28a745' : '#667eea'
                    )
                }
            }];
            
            const layout = {
                title: 'Class Probabilities',
                xaxis: { title: 'Class' },
                yaxis: { title: 'Probability' },
                margin: { t: 40, b: 100 }
            };
            
            Plotly.newPlot('classDistChart', data, layout);
        }

        // Update uptime chart
        function updateUptimeChart(uptime) {
            const now = new Date().toLocaleTimeString();
            uptimeData.x.push(now);
            uptimeData.y.push(uptime);
            
            // Keep only last 20 data points
            if (uptimeData.x.length > 20) {
                uptimeData.x.shift();
                uptimeData.y.shift();
            }
            
            const data = [{
                x: uptimeData.x,
                y: uptimeData.y,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 3 },
                marker: { size: 8 }
            }];
            
            const layout = {
                title: 'Model Uptime Over Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Uptime (seconds)' },
                margin: { t: 40, b: 60 }
            };
            
            Plotly.newPlot('uptimeChart', data, layout);
        }
    </script>
</body>
</html>
