<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fruit Classifier - Fresh vs Rotten Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.95);
            font-size: 1.1em;
        }

        /* Important Warning Box */
        .warning-box {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(45, 55, 72, 0.3);
            border-left: 5px solid #667eea;
        }

        .warning-box h3 {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .warning-box strong {
            font-weight: 700;
            text-decoration: underline;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Upload Section */
        .upload-section {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .upload-section h2 {
            color: white;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .upload-zone {
            border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eaf6 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e8eaf6 0%, #dce1f7 100%);
            transform: translateY(-2px);
        }

        .upload-zone.dragover {
            border-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-zone p {
            font-size: 1.2em;
            color: #666;
            margin: 10px 0;
        }

        .upload-zone .highlight {
            color: #667eea;
            font-weight: bold;
        }

        #fileInput {
            display: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Preview Section */
        .preview-section {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .preview-section h2 {
            color: white;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        #imagePreview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 15px;
            display: none;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eaf6 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.2em;
        }

        /* Results Section */
        .results-section {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .results-section h2 {
            color: white;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        #results {
            display: none;
        }

        .result-card {
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .result-card.high-confidence {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-left: 5px solid #00c851;
        }

        .result-card.medium-confidence {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-left: 5px solid #ffbb33;
        }

        .result-card.low-confidence {
            background: linear-gradient(135deg, #ff9999 0%, #ff6b6b 100%);
            border-left: 5px solid #ff4444;
        }

        .prediction-main {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.6em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .warning-message {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff4444;
        }

        .warning-message h4 {
            color: #ff4444;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Probabilities */
        .probabilities {
            margin-top: 25px;
        }

        .probabilities h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .prob-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: rgba(255,255,255,0.5);
            padding: 10px 15px;
            border-radius: 10px;
        }

        .prob-label {
            min-width: 150px;
            font-weight: 600;
            color: #333;
        }

        .prob-bar-container {
            flex: 1;
            height: 25px;
            background: rgba(255,255,255,0.8);
            border-radius: 50px;
            overflow: hidden;
            margin: 0 15px;
            position: relative;
        }

        .prob-bar {
            height: 100%;
            border-radius: 50px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .prob-value {
            font-weight: bold;
            min-width: 60px;
            text-align: right;
            color: #333;
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            color: white;
        }

        .info-card h3 {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card ul {
            margin-left: 20px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.95);
        }

        /* Footer */
        .footer {
            text-align: center;
            color: white;
            padding: 20px;
            margin-top: 30px;
        }

        .footer a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                AI-Powered Fruit Quality Classifier
            </h1>
            <p>Advanced Machine Learning Model for Fresh vs Rotten Fruit Detection</p>
        </div>

        <!-- Model Scope & Specifications -->
        <div class="warning-box">
            <h3>Cutting-Edge AI Technology</h3>
            <p style="line-height: 1.9; font-size: 1.08em; font-weight: 300;">
                Experience the power of <strong style="color: #a78bfa;">advanced deep learning</strong> with our state-of-the-art neural network. 
                Trained on thousands of images, this intelligent system accurately classifies <strong style="color: #a78bfa;">apples, bananas, and oranges</strong> 
                while detecting their freshness state in <strong style="color: #a78bfa;">real-time</strong>. Simply upload a clear, well-lit image and witness 
                AI-driven precision in action.
            </p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2>Upload Fruit Image</h2>
                <div class="upload-zone" id="dropZone">
                    <p><span class="highlight">Click to upload</span> or drag and drop</p>
                    <p style="font-size: 0.9em; color: #999;">Supported: JPG, PNG, JPEG</p>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <button class="btn-primary" id="predictBtn" disabled>
                    Predict Image
                </button>
            </div>

            <!-- Preview Section -->
            <div class="preview-section">
                <h2>Image Preview</h2>
                <img id="imagePreview" alt="Preview">
                <div class="placeholder" id="placeholder">
                    <span>üì∑ No image selected</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <h2>Prediction Results</h2>
            
            <!-- Loading Animation -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your image with AI...</p>
            </div>

            <!-- Results -->
            <div id="results"></div>
        </div>

        <!-- Model Statistics Dashboard -->
        <div class="results-section" style="margin-bottom: 30px;">
            <h2>Model Statistics & Performance</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center;">
                    <h3 style="color: white; font-size: 2em; margin: 0;" id="modelUptime">--</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">Model Uptime</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center;">
                    <h3 style="color: white; font-size: 2em; margin: 0;" id="predictionCount">0</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">Total Predictions</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center;">
                    <h3 style="color: white; font-size: 2em; margin: 0;" id="modelStatus">‚óè</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">Model Status</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center;">
                    <h3 style="color: white; font-size: 2em; margin: 0;">97.2%</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-top: 10px;">Model Accuracy</p>
                </div>
            </div>
        </div>

        <!-- Bulk Upload & Retraining Section -->
        <div class="upload-section" style="margin-bottom: 30px;">
            <h2>Bulk Data Upload & Model Retraining</h2>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">Upload multiple images to retrain the model with new data</p>
            
            <div style="margin-bottom: 20px;">
                <label style="color: white; display: block; margin-bottom: 10px; font-weight: bold;">Select Fruit Class:</label>
                <select id="fruitClass" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; font-size: 1em;">
                    <option value="freshapples">Fresh Apples</option>
                    <option value="rottenapples">Rotten Apples</option>
                    <option value="freshbanana">Fresh Bananas</option>
                    <option value="rottenbanana">Rotten Bananas</option>
                    <option value="freshoranges">Fresh Oranges</option>
                    <option value="rottenoranges">Rotten Oranges</option>
                </select>
            </div>

            <div class="upload-zone" id="bulkDropZone" style="margin-bottom: 20px;">
                <p><span class="highlight">Click to upload multiple images</span> or drag and drop</p>
                <p style="font-size: 0.9em; color: rgba(255,255,255,0.7);">Select multiple files (JPG, PNG, JPEG)</p>
                <input type="file" id="bulkFileInput" accept="image/*" multiple>
            </div>

            <div id="uploadProgress" style="display: none; margin-bottom: 20px;">
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px;">
                    <p style="color: white; margin-bottom: 10px;"><span id="uploadedCount">0</span> files uploaded</p>
                    <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div id="uploadBar" style="background: #a78bfa; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <button class="btn-primary" id="uploadBulkBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin-right: 10px;">
                Upload Training Data
            </button>
            <button class="btn-primary" id="retrainBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                Trigger Retraining
            </button>

            <div id="retrainStatus" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px;">
                <p style="color: white; font-weight: bold;">Retraining Status: <span id="retrainMessage">Starting...</span></p>
                <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; overflow: hidden; margin-top: 10px;">
                    <div id="retrainBar" style="background: #a78bfa; height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>

        <!-- Data Visualizations Section -->
        <div class="results-section" style="margin-bottom: 30px;">
            <h2>Dataset Insights & Visualizations</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                
                <!-- Class Distribution -->
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                    <h3 style="color: white; margin-bottom: 15px;">Class Distribution</h3>
                    <canvas id="classDistChart" style="max-height: 250px;"></canvas>
                </div>

                <!-- Fresh vs Rotten -->
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                    <h3 style="color: white; margin-bottom: 15px;">Fresh vs Rotten</h3>
                    <canvas id="freshRottenChart" style="max-height: 250px;"></canvas>
                </div>

                <!-- Training Performance -->
                <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                    <h3 style="color: white; margin-bottom: 15px;">Model Performance</h3>
                    <canvas id="performanceChart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <!-- Data Insights -->
            <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; border-left: 5px solid #a78bfa;">
                <h3 style="color: white; margin-bottom: 15px;">Key Dataset Insights</h3>
                <ul style="color: rgba(255,255,255,0.9); line-height: 1.8;">
                    <li><strong>Total Images:</strong> 13,599 training images across 6 classes</li>
                    <li><strong>Balance:</strong> Dataset is well-balanced with ~2,200-2,300 images per class</li>
                    <li><strong>Quality:</strong> High-resolution images with diverse lighting and angles</li>
                    <li><strong>Augmentation:</strong> Data augmentation applied for better generalization</li>
                </ul>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="info-cards">
            <div class="info-card">
                <h3>Supported Fruits</h3>
                <ul>
                    <li>Apples (Fresh & Rotten)</li>
                    <li>Bananas (Fresh & Rotten)</li>
                    <li>Oranges (Fresh & Rotten)</li>
                </ul>
            </div>

            <div class="info-card">
                <h3>Best Practices</h3>
                <ul>
                    <li>Use well-lit, clear photos</li>
                    <li>Show the fruit clearly</li>
                    <li>Avoid blurry images</li>
                    <li>Single fruit per image works best</li>
                </ul>
            </div>

            <div class="info-card">
                <h3>Confidence Levels</h3>
                <ul>
                    <li><strong style="color: #00c851;">High (‚â•70%):</strong> Very reliable</li>
                    <li><strong style="color: #ffbb33;">Medium (50-70%):</strong> Uncertain</li>
                    <li><strong style="color: #ff4444;">Low (<50%):</strong> Likely wrong image type</li>
                </ul>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Powered by MobileNetV2 Transfer Learning | Built for Fruit Quality Detection</p>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const placeholder = document.getElementById('placeholder');
        const predictBtn = document.getElementById('predictBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        let selectedFile = null;

        // Click to upload
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            selectedFile = file;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                placeholder.style.display = 'none';
                predictBtn.disabled = false;
                results.style.display = 'none';
            };

            reader.readAsDataURL(file);
        }

        // Predict button
        predictBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Show loading
            loading.style.display = 'block';
            results.style.display = 'none';
            predictBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                } else {
                    throw new Error(data.error || 'Prediction failed');
                }
            } catch (error) {
                results.innerHTML = `
                    <div class="result-card low-confidence">
                        <div class="warning-message">
                            <h4>Error</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
                results.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                predictBtn.disabled = false;
            }
        });

        function displayResults(data) {
            const confidence = data.confidence;
            const isLikelyFruit = data.is_likely_fruit !== false; // Default to true if not present
            const apiWarning = data.warning; // Warning from API
            
            let confidenceClass = 'low-confidence';
            let confidenceEmoji = '‚ùå';
            let confidenceText = 'LOW CONFIDENCE';
            
            // Special case: Suspiciously high confidence (>95%) often means wrong image
            if (confidence > 0.95 && !isLikelyFruit) {
                confidenceClass = 'low-confidence';
                confidenceEmoji = 'üö®';
                confidenceText = 'SUSPICIOUS OVERCONFIDENCE';
            } else if (confidence >= 0.7) {
                confidenceClass = 'high-confidence';
                confidenceEmoji = '‚úÖ';
                confidenceText = 'HIGH CONFIDENCE';
            } else if (confidence >= 0.5) {
                confidenceClass = 'medium-confidence';
                confidenceEmoji = '‚ö†Ô∏è';
                confidenceText = 'MEDIUM CONFIDENCE';
            }

            // Determine if it's fresh or rotten
            const predClass = data.predicted_class.toLowerCase();
            const isFresh = predClass.includes('fresh');
            const fruitType = predClass.replace('fresh', '').replace('rotten', '');
            const condition = isFresh ? 'FRESH' : 'ROTTEN';
            const fruitEmoji = '';

            let warningHTML = '';
            
            // Show API warning if present (better detection)
            if (apiWarning) {
                const warningType = !isLikelyFruit ? 'WRONG IMAGE TYPE' : 'UNCERTAIN PREDICTION';
                warningHTML = `
                    <div class="warning-message">
                        <h4>${warningType}</h4>
                        <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>${apiWarning}</strong></p>
                        ${!isLikelyFruit ? `
                        <p><strong>THIS PREDICTION IS LIKELY WRONG!</strong></p>
                        <p>The model detected that this is probably NOT a fruit image.</p>
                        <p style="margin-top: 10px;">Common mistakes:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Screenshot or document</li>
                            <li>Person or face</li>
                            <li>Object or scene</li>
                            <li>Unsupported fruit (only apples, bananas, oranges work)</li>
                        </ul>
                        ` : ''}
                        <p style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.3); border-radius: 5px;">
                            <strong>Solution:</strong> Upload a clear photo of an apple, banana, or orange.
                        </p>
                    </div>
                `;
            } else if (confidence < 0.7) {
                warningHTML = `
                    <div class="warning-message">
                        <h4>Warning: Low Confidence Prediction</h4>
                        <p><strong>This prediction may be incorrect!</strong></p>
                        <p>Possible reasons:</p>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>The image is not a fruit (person, object, etc.)</li>
                            <li>The image is a fruit not supported by this model</li>
                            <li>The image quality is too poor or blurry</li>
                            <li>The fruit is not clearly visible</li>
                        </ul>
                        <p style="margin-top: 10px;"><strong>Recommendation:</strong> Please upload a clear image of an apple, banana, or orange for accurate results.</p>
                    </div>
                `;
            }

            // Create probabilities HTML
            const sortedProbs = Object.entries(data.probabilities)
                .sort((a, b) => b[1] - a[1])
                .map(([className, prob]) => {
                    const percentage = (prob * 100).toFixed(1);
                    
                    return `
                        <div class="prob-item">
                            <div class="prob-label">${className}</div>
                            <div class="prob-bar-container">
                                <div class="prob-bar" style="width: ${percentage}%"></div>
                            </div>
                            <div class="prob-value">${percentage}%</div>
                        </div>
                    `;
                }).join('');

            results.innerHTML = `
                <div class="result-card ${confidenceClass}">
                    <div class="prediction-main">
                        <span>${fruitEmoji}</span>
                        <span>${condition} ${fruitType.toUpperCase()}</span>
                        <span class="confidence-badge">${confidenceEmoji} ${confidenceText}</span>
                    </div>
                    <p style="font-size: 1.2em; margin-bottom: 10px;">
                        Confidence: <strong>${(confidence * 100).toFixed(1)}%</strong>
                    </p>
                    ${warningHTML}
                    <div class="probabilities">
                        <h3>All Class Probabilities:</h3>
                        ${sortedProbs}
                    </div>
                </div>
            `;

            results.style.display = 'block';
        }

        // Load model statistics
        async function loadModelStats() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                document.getElementById('modelUptime').textContent = formatUptime(data.uptime_seconds);
                document.getElementById('predictionCount').textContent = data.prediction_count || 0;
                document.getElementById('modelStatus').textContent = data.status === 'healthy' ? '‚óè Online' : '‚óè Offline';
                document.getElementById('modelStatus').style.color = data.status === 'healthy' ? '#00c851' : '#ff4444';
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 24) {
                return Math.floor(hours / 24) + 'd ' + (hours % 24) + 'h';
            }
            return hours + 'h ' + minutes + 'm';
        }

        // Bulk upload functionality
        const bulkDropZone = document.getElementById('bulkDropZone');
        const bulkFileInput = document.getElementById('bulkFileInput');
        const uploadBulkBtn = document.getElementById('uploadBulkBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadedCount = document.getElementById('uploadedCount');
        const uploadBar = document.getElementById('uploadBar');

        bulkDropZone.addEventListener('click', () => bulkFileInput.click());

        bulkDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            bulkDropZone.classList.add('dragover');
        });

        bulkDropZone.addEventListener('dragleave', () => {
            bulkDropZone.classList.remove('dragover');
        });

        bulkDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            bulkDropZone.classList.remove('dragover');
            bulkFileInput.files = e.dataTransfer.files;
        });

        uploadBulkBtn.addEventListener('click', async () => {
            const files = bulkFileInput.files;
            const fruitClass = document.getElementById('fruitClass').value;

            if (files.length === 0) {
                alert('Please select images to upload');
                return;
            }

            uploadProgress.style.display = 'block';
            uploadBulkBtn.disabled = true;
            let uploaded = 0;

            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('file', files[i]);
                formData.append('fruit_class', fruitClass);

                try {
                    const response = await fetch('/upload-training-data', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        uploaded++;
                        uploadedCount.textContent = uploaded;
                        uploadBar.style.width = ((uploaded / files.length) * 100) + '%';
                    }
                } catch (error) {
                    console.error('Upload failed:', error);
                }
            }

            alert(`Successfully uploaded ${uploaded} images to ${fruitClass}`);
            uploadBulkBtn.disabled = false;
            bulkFileInput.value = '';
        });

        // Retrain functionality
        const retrainBtn = document.getElementById('retrainBtn');
        const retrainStatus = document.getElementById('retrainStatus');
        const retrainMessage = document.getElementById('retrainMessage');
        const retrainBar = document.getElementById('retrainBar');

        retrainBtn.addEventListener('click', async () => {
            if (!confirm('This will retrain the model with uploaded data. This may take several minutes. Continue?')) {
                return;
            }

            retrainStatus.style.display = 'block';
            retrainBtn.disabled = true;
            retrainMessage.textContent = 'Starting retraining...';
            retrainBar.style.width = '0%';

            try {
                const response = await fetch('/retrain', {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    // Poll for status
                    const checkStatus = setInterval(async () => {
                        const statusResponse = await fetch('/retraining-status');
                        const statusData = await statusResponse.json();

                        retrainMessage.textContent = statusData.message;
                        retrainBar.style.width = statusData.progress + '%';

                        if (!statusData.is_retraining) {
                            clearInterval(checkStatus);
                            retrainBtn.disabled = false;
                            alert('Retraining complete! Model has been updated.');
                            loadModelStats(); // Refresh stats
                        }
                    }, 2000);
                } else {
                    throw new Error(data.detail || 'Retraining failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                retrainBtn.disabled = false;
                retrainStatus.style.display = 'none';
            }
        });

        // Initialize charts
        function initCharts() {
            // Class Distribution Chart
            const classCtx = document.getElementById('classDistChart').getContext('2d');
            new Chart(classCtx, {
                type: 'bar',
                data: {
                    labels: ['Fresh Apples', 'Rotten Apples', 'Fresh Bananas', 'Rotten Bananas', 'Fresh Oranges', 'Rotten Oranges'],
                    datasets: [{
                        label: 'Number of Images',
                        data: [2342, 2287, 2290, 2224, 2426, 2030],
                        backgroundColor: ['#00c851', '#ff4444', '#00c851', '#ff4444', '#00c851', '#ff4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white', font: { size: 10 } },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Fresh vs Rotten Chart
            const freshRottenCtx = document.getElementById('freshRottenChart').getContext('2d');
            new Chart(freshRottenCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Fresh', 'Rotten'],
                    datasets: [{
                        data: [7058, 6541],
                        backgroundColor: ['#00c851', '#ff4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: 'white', font: { size: 14 } }
                        }
                    }
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: ['Epoch 1', 'Epoch 2', 'Epoch 3', 'Epoch 4', 'Epoch 5'],
                    datasets: [{
                        label: 'Training Accuracy',
                        data: [0.75, 0.85, 0.92, 0.95, 0.972],
                        borderColor: '#a78bfa',
                        backgroundColor: 'rgba(167, 139, 250, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Validation Accuracy',
                        data: [0.73, 0.83, 0.90, 0.94, 0.968],
                        borderColor: '#00c851',
                        backgroundColor: 'rgba(0, 200, 81, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: 'white', font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 1,
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: { 
                            ticks: { color: 'white' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Load stats on page load
        loadModelStats();
        setInterval(loadModelStats, 5000); // Update every 5 seconds

        // Initialize charts when page loads
        window.addEventListener('load', () => {
            // Load Chart.js from CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
            script.onload = initCharts;
            document.head.appendChild(script);
        });
    </script>
</body>
</html>